<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ doc.original_name or doc.filename }} - PDF Viewer</title>
  <link rel="stylesheet" href="/static/document-viewer.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="toolbar">
    <a href="/" class="back-link" id="back-to-para">← Back to PARA</a>
    <a href="/api/documents/{{ doc_id }}/file" download="{{ doc.original_name or doc.filename }}" id="btn-download" class="toolbar-link">Download</a>
    <a href="#" id="btn-download-with-markups" class="toolbar-link toolbar-link-secondary">Download with markups</a>
    <button type="button" id="btn-save-pdf" class="toolbar-link btn-secondary">Save PDF</button>
    <span class="save-indicator" id="save-indicator" aria-live="polite"></span>
    <button type="button" id="btn-edit" class="btn-primary">Edit</button>
    <span class="edit-mode-only" id="edit-mode-only" style="display: none;">
      <span class="mode-group">
        <button type="button" id="btn-mode-none">Cursor</button>
        <button type="button" id="btn-mode-highlight">Highlight</button>
        <span class="highlight-color-picker" id="highlight-color-picker" title="Highlight color">
          <span class="color-swatch" data-color="#ffeb3b" title="Yellow"></span>
          <span class="color-swatch" data-color="#86efac" title="Green"></span>
          <span class="color-swatch" data-color="#93c5fd" title="Blue"></span>
          <span class="color-swatch" data-color="#f9a8d4" title="Pink"></span>
          <span class="color-swatch" data-color="#fdba74" title="Orange"></span>
          <span class="color-swatch" data-color="#fca5a5" title="Red"></span>
        </span>
        <button type="button" id="btn-mode-draw" title="Draw with pen">Draw</button>
        <button type="button" id="btn-mode-text" title="Add text on page">Text</button>
        <button type="button" id="btn-mode-comment">Comment</button>
      </span>
      <button type="button" id="btn-undo" title="Undo">↶ Undo</button>
      <button type="button" id="btn-redo" title="Redo">↷ Redo</button>
      <button type="button" id="btn-done" class="btn-secondary">Done</button>
    </span>
    <div class="context-wrap" id="context-wrap">
      <label for="context-select">Markups for:</label>
      <select id="context-select"></select>
      <button type="button" id="btn-history" class="btn-history" title="Markup history">History</button>
    </div>
    <div id="history-popover" class="history-popover" aria-hidden="true">
      <div class="history-popover-header">Markup history</div>
      <ul id="history-list" class="history-list"></ul>
      <p id="history-empty" class="history-empty" style="display:none;">No version history yet.</p>
    </div>
  </div>
  <div id="floating-pill" class="floating-pill" role="toolbar" aria-label="Zoom and view">
    <span class="zoom-controls">
      <button type="button" id="btn-zoom-out" aria-label="Zoom out">−</button>
      <span class="zoom-value" id="zoom-value">100%</span>
      <button type="button" id="btn-zoom-in" aria-label="Zoom in">+</button>
    </span>
    <button type="button" id="btn-print">Print</button>
  </div>

  <div id="context-menu" class="context-menu" aria-hidden="true" role="menu">
    <div id="context-menu-text-options" style="display: none;">
      <label class="context-menu-label">Size</label>
      <select id="context-menu-font-size" class="context-menu-select">
        <option value="10">10</option>
        <option value="12" selected>12</option>
        <option value="14">14</option>
        <option value="18">18</option>
        <option value="24">24</option>
      </select>
      <label class="context-menu-label">Color</label>
      <div id="context-menu-colors" class="context-menu-colors"></div>
    </div>
    <button type="button" id="context-menu-delete" class="context-menu-delete" role="menuitem">Delete</button>
  </div>

  <div class="pdf-container" id="pdf-container">
    <div id="pdf-display-wrap" style="flex:1;display:flex;flex-direction:column;min-height:0;transform-origin:top left;">
      <object data="/api/documents/{{ doc_id }}/file" type="application/pdf" class="pdf-object">
        <p class="pdf-fallback">Your browser cannot display PDFs inline. <a href="/api/documents/{{ doc_id }}/file" target="_blank" rel="noopener">Open PDF in new tab</a></p>
      </object>
    </div>
  </div>

  <div id="text-modal-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="text-modal-title">
      <h3 id="text-modal-title">Add text</h3>
      <textarea id="text-modal-input" placeholder="Enter text..." rows="4"></textarea>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" id="text-modal-cancel">Cancel</button>
        <button type="button" class="btn-save" id="text-modal-save">Save</button>
      </div>
    </div>
  </div>

  <script src="/static/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@floating-ui/core@1.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.6.0"></script>
  <script>
    window.__PDF_CONFIG__ = {
      docId: {{ doc_id }},
      linkedType: {{ linked_type | tojson if linked_type is not none else 'null' }},
      linkedId: {{ linked_id | tojson if linked_id is not none else 'null' }}
    };
  </script>
  <script src="/static/pdf-editor/state.js"></script>
  <script src="/static/pdf-editor/utils.js"></script>
  <script src="/static/pdf-editor/fabric-layer.js"></script>
  <script src="/static/pdf-editor/markup-tools.js"></script>
  <script src="/static/pdf-editor/undo-manager.js"></script>
  <script src="/static/pdf-editor/save-manager.js"></script>
  <script src="/static/pdf-editor/context-selector.js"></script>
  <script src="/static/pdf-editor/annotation-layer.js"></script>
  <script src="/static/pdf-editor/pdf-viewer.js"></script>
  <script src="/static/pdf-editor/main.js"></script>
</body>
</html>
